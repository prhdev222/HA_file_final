{% extends "base.html" %}

{% block title %}จัดการหน่วยงาน - แอดมิน{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h2><i class="fas fa-hospital me-2"></i>จัดการหน่วยงาน</h2>
                <a href="{{ url_for('admin_dashboard') }}" class="btn btn-secondary">
                    <i class="fas fa-arrow-left me-2"></i>กลับไปหน้าแดชบอร์ด
                </a>
            </div>

            <!-- สถิติ -->
            <div class="row mb-4">
                <div class="col-md-3">
                    <div class="card bg-info text-white">
                        <div class="card-body">
                            <h5 class="card-title">จำนวนหน่วยงานทั้งหมด</h5>
                            <h2>{{ departments|length }}</h2>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ตารางหน่วยงาน -->
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0"><i class="fas fa-list me-2"></i>รายการหน่วยงานทั้งหมด</h5>
                </div>
                <div class="card-body">
                    {% if departments %}
                        <div class="table-responsive">
                            <table class="table table-striped table-hover">
                                <thead class="table-dark">
                                    <tr>
                                        <th>ลำดับ</th>
                                        <th>รหัส</th>
                                        <th>ชื่อหน่วยงาน</th>
                                        <th>คำอธิบาย</th>
                                        <th>วันที่สร้าง</th>
                                        <th>วันที่อัปเดต</th>
                                        <th>สถิติ</th>
                                        <th>การจัดการ</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for dept in departments %}
                                    <tr>
                                        <td>{{ loop.index }}</td>
                                        <td>
                                            <span class="badge bg-primary">{{ dept.code }}</span>
                                        </td>
                                        <td>
                                            <strong>{{ dept.name }}</strong>
                                        </td>
                                        <td>
                                            {% if dept.description %}
                                                {{ dept.description[:100] }}{% if dept.description|length > 100 %}...{% endif %}
                                            {% else %}
                                                <span class="text-muted">ไม่มีคำอธิบาย</span>
                                            {% endif %}
                                        </td>
                                        <td>{{ dept.created_at.strftime('%d/%m/%Y %H:%M') }}</td>
                                        <td>{{ dept.updated_at.strftime('%d/%m/%Y %H:%M') }}</td>
                                        <td>
                                            <div class="small">
                                                <div class="text-primary">
                                                    <i class="fas fa-file-medical me-1"></i>
                                                    Guidelines: {{ dept.guidelines|length }}
                                                </div>
                                                <div class="text-success">
                                                    <i class="fas fa-book me-1"></i>
                                                    Knowledge: {{ dept.knowledge|length }}
                                                </div>
                                                <div class="text-warning">
                                                    <i class="fas fa-calendar me-1"></i>
                                                    Activities: {{ dept.activities|length }}
                                                </div>
                                            </div>
                                        </td>
                                        <td>
                                            <div class="btn-group" role="group">
                                                <a href="{{ url_for('department', dept_id=dept.id) }}" 
                                                   class="btn btn-sm btn-outline-info" target="_blank">
                                                    <i class="fas fa-eye"></i>
                                                </a>
                                                <button type="button" class="btn btn-sm btn-outline-primary" 
                                                        onclick="editDepartment({{ dept.id }})">
                                                    <i class="fas fa-edit"></i>
                                                </button>
                                                <button type="button" class="btn btn-sm btn-outline-danger" 
                                                        onclick="deleteDepartment({{ dept.id }})">
                                                    <i class="fas fa-trash"></i>
                                                </button>
                                            </div>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    {% else %}
                        <div class="text-center py-5">
                            <i class="fas fa-hospital fa-3x text-muted mb-3"></i>
                            <h5 class="text-muted">ยังไม่มีข้อมูลหน่วยงาน</h5>
                            <p class="text-muted">หน่วยงานจะถูกสร้างอัตโนมัติเมื่อเริ่มต้นระบบ</p>
                        </div>
                    {% endif %}
                </div>
            </div>

            <!-- ข้อมูลเพิ่มเติม -->
            <div class="row mt-4">
                <div class="col-md-6">
                    <div class="card">
                        <div class="card-header bg-light">
                            <h6 class="mb-0"><i class="fas fa-info-circle me-2"></i>ข้อมูลหน่วยงาน</h6>
                        </div>
                        <div class="card-body">
                            <p class="mb-2"><strong>จำนวนหน่วยงาน:</strong> {{ departments|length }}</p>
                            <p class="mb-2"><strong>หน่วยงานล่าสุด:</strong> 
                                {% if departments %}
                                    {{ departments[-1].name }} ({{ departments[-1].code }})
                                {% else %}
                                    ไม่มี
                                {% endif %}
                            </p>
                            <p class="mb-0"><strong>อัปเดตล่าสุด:</strong> 
                                {% if departments %}
                                    {{ departments[-1].updated_at.strftime('%d/%m/%Y %H:%M') }}
                                {% else %}
                                    ไม่มี
                                {% endif %}
                            </p>
                        </div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="card">
                        <div class="card-header bg-light">
                            <h6 class="mb-0"><i class="fas fa-cog me-2"></i>การจัดการ</h6>
                        </div>
                        <div class="card-body">
                            <p class="text-muted small mb-2">
                                หน่วยงานถูกสร้างอัตโนมัติตามที่กำหนดในระบบ
                            </p>
                            <p class="text-muted small mb-2">
                                สามารถแก้ไขข้อมูลและลบได้ (ระวัง: การลบจะลบข้อมูลที่เกี่ยวข้องทั้งหมด)
                            </p>
                            <p class="text-muted small mb-0">
                                คลิกปุ่ม "ดู" เพื่อดูหน้าหน่วยงานแบบผู้ใช้
                            </p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal สำหรับแก้ไขหน่วยงาน -->
<div class="modal fade" id="editDepartmentModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">แก้ไขข้อมูลหน่วยงาน</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="editDepartmentForm">
                    <div class="mb-3">
                        <label for="editDeptName" class="form-label">ชื่อหน่วยงาน *</label>
                        <input type="text" class="form-control" id="editDeptName" required>
                    </div>
                    <div class="mb-3">
                        <label for="editDeptCode" class="form-label">รหัสหน่วยงาน *</label>
                        <input type="text" class="form-control" id="editDeptCode" required>
                    </div>
                    <div class="mb-3">
                        <label for="editDeptDescription" class="form-label">คำอธิบาย</label>
                        <textarea class="form-control" id="editDeptDescription" rows="3"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ยกเลิก</button>
                <button type="button" class="btn btn-primary" onclick="saveDepartmentEdit()">บันทึก</button>
            </div>
        </div>
    </div>
</div>

<script>
function editDepartment(id) {
    // TODO: ดึงข้อมูลหน่วยงานและแสดงในฟอร์ม
    alert('ฟีเจอร์แก้ไขหน่วยงานจะเปิดใช้งานเร็วๆ นี้');
}

function deleteDepartment(id) {
    if (confirm('คุณแน่ใจหรือไม่ที่จะลบหน่วยงานนี้? การลบจะลบข้อมูลที่เกี่ยวข้องทั้งหมด (Guidelines, Knowledge, Activities, Contacts)')) {
        // TODO: ลบหน่วยงาน
        alert('ฟีเจอร์ลบหน่วยงานจะเปิดใช้งานเร็วๆ นี้');
    }
}

function saveDepartmentEdit() {
    // TODO: บันทึกการแก้ไขหน่วยงาน
    alert('ฟีเจอร์บันทึกการแก้ไขหน่วยงานจะเปิดใช้งานเร็วๆ นี้');
}
</script>
{% endblock %}
